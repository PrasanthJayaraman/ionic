<html>

<head>
    <title>Jobswala</title>
    <link rel="stylesheet" href="/modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/app.css">
    <link rel="stylesheet" href="/assets/header.css">
    <link rel="stylesheet" href="/assets/editor/jquery-te-1.4.0.css">
    <link rel="stylesheet" href="/modules/toastr/build/toastr.min.css">
</head>

<body>
    <%- include header.ejs %>
    <% if(data.title) { %>
        <div class="container">
            <h2>Update Post</h2>
            <div class="row">
                <form id="updateForm">
                    <table id="post-table">
                        <tr>
                            <td>
                                <label for="">Select Categories</label>
                            </td>
                            <td>
                                <div class="dropdown-container" id="dropdown-container">
                                    <div class="dropdown-button noselect">
                                        <div class="dropdown-label">Categories</div>
                                        <div class="dropdown-quantity">(
                                            <span class="quantity">Any</span>)</div>
                                    </div>
                                    <div class="dropdown-list" id="dropdown-list" style="display: none;">
                                        <input type="search" class="form-control dropdown-search" placeholder="Search states" id="dropdown-search" style="padding-left: 10px;"
                                        />
                                        <ul>
                                            <% categories.forEach(function(cat){ %>                                                                                                
                                                <% if(data.categories.indexOf(cat.name) > -1) { %>                                                                                                
                                                <li class="list-cat">
                                                    <input class="select-check" name="<%=cat.name %>" value="<%=cat.name %>" checked="true" type="checkbox">
                                                        <label for="<%=cat.name %>">
                                                            <%= cat.name %>
                                                        </label>
                                                </li>
                                                <% } else { %>
                                                    <li class="list-cat">
                                                        <input class="select-check" name="<%=cat.name %>" value="<%=cat.name %>" type="checkbox">
                                                            <label for="<%=cat.name %>">
                                                                <%= cat.name %>
                                                            </label>
                                                    </li>
                                                <% } %>
                                            <% }) %>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="" >Upload Image</label>
                            </td>
                            <td>
                                <input id="fileupload" type="file" name="files" data-url="/post/image">
                                <p style="font-size:12;margin-top:5px;">Upload a new image only if you want to replace the old image..</p>
                            </td>
                            <input type="hidden" id="url" value=<%=data.image %>>
                        </tr>
                        <tr>
                            <td>
                                <label for="">Title</label>
                            </td>
                            <td>
                                <div class="form-group">
                                    <input type="text" id="title" class="form-control" value="<%=data.title %>" placeholder="Title">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="">Notification URL</label>
                            </td>
                            <td>
                                <div class="form-group">
                                    <input type="text" id="notify" class="form-control" value="<%=data.notifyUrl %>" placeholder="Notification URL">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="">Apply URL</label>
                            </td>
                            <td>
                                <div class="form-group">
                                    <input type="text" id="apply" class="form-control" value="<%=data.applyUrl %>" placeholder="Apply URL">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="">Active</label>
                            </td>
                            <td>
                                <input type="checkbox" name="active" id="active" <%= data.active ? 'checked' : '' %>>
                                <label for="">Make Post Active</label>
                            </td>
                        </tr>
                    </table>
                    <div class="form-group" style="padding-left:10px;">
                        <label for="">Post Content</label>
                        <textarea name="textarea" id="content"  class="jqte-test"><%=data.body %></textarea>
                    </div>
                    <p>
                        <input type="submit" class="btn btn-primary btn-lg btn-block" value="Update" />
                        <input type="button" class="btn btn-default btn-lg btn-block" id="cancel" value="Cancel">
                    </p>                    
                </form>
                <br>
            </div>
        </div>
    <% } else { %>
        <div class="container">
            <h2>Create Post</h2>
            <div class="row">                
                <form id="postForm">
                    <table id="post-table">
                        <tr>
                            <td>
                                <label for="">Select Categories</label>
                            </td>
                            <td>
                                <div class="dropdown-container" id="dropdown-container">
                                    <div class="dropdown-button noselect">
                                        <div class="dropdown-label">Categories</div>
                                        <div class="dropdown-quantity">(
                                            <span class="quantity">Any</span>)</div>
                                    </div>
                                    <div class="dropdown-list" id="dropdown-list" style="display: none;">
                                        <input type="search" class="form-control dropdown-search" placeholder="Search states" id="dropdown-search" style="padding-left: 10px;"
                                        />
                                        <ul>
                                            <% categories.forEach(function(cat){ %>
                                                <% console.log(cat); %>
                                                <li class="list-cat">
                                                    <input class="select-check" name="<%= cat.name %>" value="<%= cat.name %>" type="checkbox">
                                                        <label for="<%=cat.name %>">
                                                            <%= cat.name %>
                                                        </label>
                                                </li>
                                                <% }) %>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="">Upload Image</label>
                            </td>
                            <td>
                                <input id="fileupload" type="file" name="files" data-url="/post/image">
                            </td>
                            <input type="hidden" id="url">
                        </tr>
                        <tr>
                            <td>
                                <label for="">Title</label>
                            </td>
                            <td>
                                <div class="form-group">
                                    <input type="text" id="title" class="form-control" placeholder="Title">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="">Notification URL</label>
                            </td>
                            <td>
                                <div class="form-group">
                                    <input type="text" id="notify" class="form-control" placeholder="Notification URL">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="">Apply URL</label>
                            </td>
                            <td>
                                <div class="form-group">
                                    <input type="text" id="apply" class="form-control" placeholder="Apply URL">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="">Active</label>
                            </td>
                            <td>
                                <input type="checkbox" name="active" id="active">
                                <label for="">Make Post Active</label>
                            </td>
                        </tr>
                    </table>
                    <div class="form-group" style="padding-left:10px;">
                        <label for="">Post Content</label>
                        <textarea name="textarea" id="content" class="jqte-test"></textarea>
                    </div>
                    <p>
                        <input type="submit" class="btn btn-primary btn-lg btn-block" value="POST" />
                        <input type="button" class="btn btn-default btn-lg btn-block" id="cancel" value="Cancel">
                    </p>
                </form>
                <br>
            </div>
        </div>
    <% } %>
</body>
<script src="/modules/jquery/dist/jquery.min.js"></script>
<script src="/modules/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/assets/editor/jquery-te-1.4.0.min.js"></script>
<script src="/assets/js/jquery.ui.widget.js"></script>
<script src="/assets/js/jquery.iframe-transport.js"></script>
<script src="/assets/js/jquery.fileupload.js"></script>
<script src="/modules/toastr/build/toastr.min.js"></script>
<script>
    $("#cancel").on("click", cancel);

    function cancel() {
        window.location.href = '/';
    }

    $('#dropdown-list').toggle();
    $('#dropdown-container')
        .on('input', '#dropdown-search', function () {
            var target = $(this);
            var search = target.val().toLowerCase();

            if (!search) {
                $('.list-cat').show();
                return false;
            }

            $('.list-cat').each(function () {
                var text = $(this).text().toLowerCase();
                var match = text.indexOf(search) > -1;
                $(this).toggle(match);
            });
        })
        .on('change', '.select-check', function () {
            var numChecked = $('input:checkbox.select-check:checked').length;
            $('.quantity').text(numChecked || 'Any');
        });

    $(document).ready(function () {
        var path = window.location.href;

        if (!window.localStorage.getItem('loggedIn')) {
            window.location.replace('/login');
        } 

        $('ul.nav li a').each(function () {
            if (this.href === path) {
                $(this).parent('li').addClass('active');
            } else {
                $('#dashboard').addClass('active');
            }
        });
       
         $('#fileupload').fileupload({ 
             dataType: 'json', 
             progress: function (e, data) {
                 var progress = parseInt(data.loaded / data.total * 100, 10);
                 showLoader();
             },
             done: function (e, data) { 
                 hideLoader();
                if(data.result){
                    if(data.result.response == 200){
                        document.getElementById("url").value = data.result.name;
                        toastr.success("File uploaded successfully");
                    } else {
                        toastr.error("Please upload a new file");
                    }
                }
            } 
        });

        $('.jqte-test').jqte();
    });

    $('#postForm').submit(function(e) {
        showLoader();
        e.preventDefault();
        var checkboxValues = [];
        var formData = {};
        $('input.select-check:checkbox:checked').each(function () {
            checkboxValues.push($(this).val());
        });
        if (checkboxValues.length == 0) {
            hideLoader();
            toastr.error("Please select categories");
            return false;
        }
        var url = $('#url').val();
        if(!url){
            hideLoader();
            toastr.error("Please upload a new image");
            return false;
        }         
        var title = $('#title').val();
        if(!title){
            hideLoader();
            toastr.error("Please enter a title");
            return false;
        } 
        var content = $('#content').val();
        if(!content){
            hideLoader();
            toastr.error("Please enter post content");
            return false;
        } 
        var active = $('#active').is(":checked");
        var notify = $('#notify').val(); 
        var apply = $('#apply').val();        
        formData.notifyUrl = notify;
        formData.applyUrl = apply;
        formData.body = content;
        formData.categories = checkboxValues;
        formData.image = url;
        formData.title = title;
        formData.active = active;
        var data = {
            post: formData
        }             
        $.ajax({
            type: 'POST',
            url: '/post/create',
            data: JSON.stringify(data),
            headers: {'Content-Type': 'application/json'},
            success: function(response){
                hideLoader();
                toastr.success("Post Created Successfully");
                window.location.replace("/posts/1");
            },
            error: function(response){
                hideLoader();
                toastr.error(response.responseJSON.message);
            }
        })
    });

    $('#updateForm').submit(function(e){
        showLoader();
        e.preventDefault();
        var checkboxValues = [];
        var formData = {};
        $('input.select-check:checkbox:checked').each(function () {
            checkboxValues.push($(this).val());
        });
        if (checkboxValues.length == 0) {
            hideLoader();
            toastr.error("Please select categories");
            return false;
        }
        var url = $('#url').val();
        if (!url) {
            hideLoader();
            toastr.error("Please upload a new image");
            return false;
        }
        var title = $('#title').val();
        if (!title) {
            hideLoader();
            toastr.error("Please enter a title");
            return false;
        }
        var content = $('#content').val();
        if (!content) {
            hideLoader();
            toastr.error("Please enter post content");
            return false;
        }
        var active = $('#active').is(":checked");
        var notify = $('#notify').val();
        var apply = $('#apply').val();
        formData.notifyUrl = notify;
        formData.applyUrl = apply;
        formData.body = content;
        formData.categories = checkboxValues;
        formData.image = url;
        formData.title = title;
        formData.active = active;
        var data = {
            post: formData
        }
        $.ajax({
            type: 'PUT',
            url: '/post/create/'+ "<%= data._id %>",
            data: JSON.stringify(data),
            headers: { 'Content-Type': 'application/json' },
            success: function (response) {
                hideLoader();
                toastr.success("Post Updated Successfully");
                window.location.replace("/posts/1");
            },
            error: function (response) {
                hideLoader();
                toastr.error(response.responseJSON.message);
            }
        })
    });
</script>

</html>